<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f0f13" />
  <title>Arcane Divination ¬∑ Tarot Reading (Refined)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0a0612;
      --panel: #120a1f;
      --muted: #9b8fb8;
      --text: #e8e4f0;
      --brand: #d946ef;
      --brand-2: #f59e0b;
      --accent: #10b981;
      --ring: 0 0 0 2px rgba(217,70,239,.35);
      --shadow: 0 10px 40px rgba(217,70,239,.25);
      --glow: 0 0 20px rgba(217,70,239,.4);
      --glass: rgba(139,92,246,.08);
      --glass-brd: rgba(139,92,246,.25);
    }
    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%}
    body{
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(ellipse 1400px 900px at 90% -15%, rgba(217,70,239,.18), transparent 55%),
        radial-gradient(ellipse 1000px 700px at 10% 100%, rgba(245,158,11,.15), transparent 50%),
        var(--bg);
      color:var(--text); line-height:1.6; letter-spacing:.2px;
      background-attachment: fixed; padding:20px;
      overflow-x:hidden;
    }

    .container{max-width:960px; margin:0 auto; position:relative; z-index:3}

    .header{text-align:center; padding:36px 20px 6px}
    .header h1{
      font-family:'Cinzel', serif; font-size:clamp(32px, 5vw, 48px);
      background:linear-gradient(120deg, var(--brand), var(--brand-2), var(--accent));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      margin-bottom:6px; font-weight:900;
    }
    .header p{color:var(--muted); font-size:15px}

    .back-btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 16px;
      background:var(--glass); border:1px solid var(--glass-brd); border-radius:12px;
      color:var(--text); text-decoration:none; transition:all .2s ease;
      font-weight:500; margin-bottom:18px;
    }
    .back-btn:hover{border-color:var(--brand); transform:translateY(-2px); box-shadow:var(--shadow)}

    .reading-selector{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
      gap:14px; margin:22px 0;
    }
    .spread-card{
      background:linear-gradient(135deg, rgba(139,92,246,.08), rgba(245,158,11,.06));
      border:1px solid var(--glass-brd); border-radius:16px; padding:20px;
      cursor:pointer; transition:all .25s ease; text-align:center;
      user-select:none;
    }
    .spread-card:hover{
      transform:translateY(-4px); border-color:var(--brand);
      box-shadow:0 12px 36px rgba(217,70,239,.32);
    }
    .spread-card.active{
      border-color:var(--brand); background:linear-gradient(135deg, rgba(139,92,246,.15), rgba(245,158,11,.08));
    }
    .spread-icon{font-size:44px; margin-bottom:10px}
    .spread-title{font-family:'Cinzel', serif; font-size:18px; font-weight:700; margin-bottom:6px}
    .spread-desc{font-size:13px; color:var(--muted)}

    .controls{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center;
      margin:6px 0 18px;
    }
    .control{
      background:var(--glass); border:1px solid var(--glass-brd); padding:8px 12px; border-radius:12px;
      color:var(--text); font-size:14px; display:flex; gap:8px; align-items:center;
    }
    .control input{transform:scale(1.1)}

    .btn{
      display:inline-flex; align-items:center; gap:10px; padding:14px 28px;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      border:none; border-radius:14px; color:#fff; font-size:16px;
      font-weight:600; cursor:pointer; transition:all .3s ease;
      box-shadow:var(--shadow); margin:20px auto; font-family:'Cinzel', serif;
    }
    .btn:hover{transform:translateY(-3px); box-shadow:0 15px 50px rgba(217,70,239,.5)}
    .btn:active{transform:translateY(-1px)}
    .btn:disabled{opacity:.5; cursor:not-allowed; transform:none}

    .cards-container{
      display:flex; justify-content:center; gap:18px; flex-wrap:wrap;
      margin:30px 0; min-height:360px; align-items:center;
      position:relative; z-index:5; /* ensure cards sit above interpretation */
    }

    .tarot-card{
      width:170px; height:270px; perspective:1100px; cursor:pointer; position:relative;
      transition:transform .15s ease;
      z-index:6; /* put each card above container surfaces */
    }
    .card-inner{
      width:100%; height:100%; position:relative; transition:transform .8s; transform-style:preserve-3d;
      will-change:transform;
      border-radius:14px;
    }
    .tarot-card.flipped .card-inner{transform:rotateY(180deg)}
    
    .card-face{
      position:absolute; width:100%; height:100%; backface-visibility:hidden;
      border-radius:14px; display:flex; flex-direction:column; align-items:center;
      justify-content:center; padding:16px; border:2px solid var(--glass-brd);
      box-shadow:var(--shadow); overflow:hidden;
    }
    /* animated card-back with sigil rotate + shimmer */
    .card-back{
      background:
        radial-gradient(ellipse at 20% 10%, rgba(255,255,255,.03), transparent 12%),
        linear-gradient(135deg, rgba(139,92,246,.22), rgba(245,158,11,.14));
      backdrop-filter:blur(8px);
      display:flex; align-items:center; justify-content:center; font-size:64px; color:rgba(255,255,255,.12);
      position:relative; overflow:visible;
    }
    .card-back .sigil{
      width:86%; height:86%;
      border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(120deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      transform-origin:center center;
      animation:spinSigil 10s linear infinite;
      box-shadow: inset 0 0 18px rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.02);
    }
    .card-back .sigil svg{display:block; width:78%; height:78%}
    @keyframes spinSigil{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    .card-back::after{
      content:''; position:absolute; left:-20%; top:-30%; width:180%; height:160%;
      background:linear-gradient(90deg, rgba(255,255,255,.02), rgba(255,255,255,0), rgba(255,255,255,.02));
      transform: skewX(-18deg);
      animation:shimmer 3.4s linear infinite;
      pointer-events:none; opacity:.7;
    }

    .card-front{
      background:linear-gradient(135deg, var(--panel), rgba(18,10,31,.95));
      transform:rotateY(180deg); text-align:center; padding:12px;
      display:flex; flex-direction:column; justify-content:flex-start; gap:8px;
    }
    .card-emoji{font-size:46px; margin-top:8px}
    .card-art{width:100%; height:110px; display:flex; align-items:center; justify-content:center; border-radius:10px; overflow:hidden; margin-top:6px}
    .card-art img{width:100%; height:100%; object-fit:cover}
    .card-name{
      font-family:'Cinzel', serif; font-size:15px; font-weight:700;
      margin-bottom:2px; color:var(--brand-2);
    }
    .card-meaning{font-size:12px; color:var(--muted); line-height:1.4}

    .reversed-indicator{
      position:absolute; top:8px; right:8px; font-size:12px; background:rgba(0,0,0,.35);
      padding:6px 8px; border-radius:999px; color:var(--brand-2); border:1px solid rgba(255,255,255,.04);
      font-weight:700;
    }

    .interpretation{
      background:linear-gradient(135deg, rgba(139,92,246,.12), rgba(245,158,11,.1));
      border:1px solid var(--glass-brd); border-radius:18px; padding:26px;
      margin:28px 0; backdrop-filter:blur(8px); box-shadow:var(--shadow);
      opacity:0; transform:translateY(20px); transition:all .6s ease;
      position:relative; z-index:4; /* lower than cards so it doesn't cover them */
    }
    .interpretation.show{opacity:1; transform:translateY(0)}
    .interpretation h2{
      font-family:'Cinzel', serif; font-size:22px; margin-bottom:14px;
      color:var(--brand-2);
    }
    .card-detail{
      margin:16px 0; padding:16px; background:rgba(0,0,0,.18);
      border-radius:10px; border-left:4px solid var(--brand);
    }
    .card-detail h3{
      font-family:'Cinzel', serif; font-size:16px; color:var(--brand);
      margin-bottom:8px; display:flex; align-items:center; gap:10px;
    }
    .card-detail p{color:var(--text); line-height:1.6}

    .fool-mode{
      background:linear-gradient(135deg, rgba(239,68,68,.15), rgba(217,70,239,.15)) !important;
      border-color:rgba(239,68,68,.5) !important;
      animation:foolPulse 2s infinite;
    }
    @keyframes foolPulse{
      0%, 100%{box-shadow:0 0 24px rgba(239,68,68,.28)}
      50%{box-shadow:0 0 44px rgba(239,68,68,.55), 0 0 60px rgba(217,70,239,.38)}
    }

    .praise{
      font-size:clamp(22px, 4vw, 32px); font-family:'Cinzel', serif;
      text-align:center; font-weight:900; margin:30px 0;
      background:linear-gradient(90deg, #ef4444, #d946ef, #f59e0b);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation:shimmer 3s infinite;
    }

    #foolCanvas{
      position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:1; mix-blend-mode:screen;
    }

    @media (max-width: 640px){
      .cards-container{gap:12px}
      .tarot-card{width:150px; height:240px}
      .spread-icon{font-size:36px}
    }
  </style>
</head>
<body>
  <canvas id="foolCanvas" aria-hidden="true"></canvas>
  <div class="container" id="app">
    <a href="index.html" class="back-btn">‚Üê Return to Grimoire</a>
    
    <div class="header">
      <h1>üîÆ Arcane Divination</h1>
      <p>Let the mystical cards reveal your destiny</p>
    </div>

    <div class="reading-selector" role="tablist">
      <div class="spread-card active" data-spread="single" role="tab" aria-selected="true">
        <div class="spread-icon">üÉè</div>
        <div class="spread-title">Single Card</div>
        <div class="spread-desc">Quick insight into your question</div>
      </div>
      <div class="spread-card" data-spread="three" role="tab">
        <div class="spread-icon">üé¥</div>
        <div class="spread-title">Three Card</div>
        <div class="spread-desc">Past, Present, Future</div>
      </div>
      <div class="spread-card" data-spread="celtic" role="tab">
        <div class="spread-icon">‚ú®</div>
        <div class="spread-title">Celtic Cross</div>
        <div class="spread-desc">Deep, comprehensive reading (simplified)</div>
      </div>
    </div>

    <div class="controls" aria-hidden="false">
      <label class="control"><input type="checkbox" id="includeMinor"> Include Minor Arcana</label>
      <label class="control"><input type="checkbox" id="showReversals" checked> Allow Reversals</label>
      <label class="control"><input type="checkbox" id="enableSound"> Ambient Sound</label>
    </div>

    <center>
      <button class="btn" id="drawBtn">‚ú® Divine Your Fate ‚ú®</button>
    </center>

    <div class="cards-container" id="cardsContainer" aria-live="polite"></div>
    <div class="interpretation" id="interpretation" aria-live="polite"></div>
  </div>

  <script>
    // Major arcana with expanded in-depth detail (added reflective guidance & actionable advice)
    const majorArcana = [
      {
        name: 'The Fool', emoji: 'üÉè', meaning: 'New beginnings, innocence, spontaneity, free spirit',
        detail: 'The Fool marks a threshold: an invitation to step into the unknown with curiosity. This card encourages risk taken from a place of openness rather than ignorance. Practically, it can indicate a fresh project, a move, or the need to release overly cautious patterns. Reflection: what small first step can you take that requires faith more than certainty?',
        reversed: 'Recklessness, naivety, hesitation to begin despite desire.'
      },
      {
        name: 'The Magician', emoji: 'üé©', meaning: 'Manifestation, resourcefulness, power, inspired action',
        detail: 'The Magician calls attention to your agency ‚Äî the tools, skills, and influence that are available right now. This is a time to concentrate your attention and craft deliberate action. Actionable advice: write a short plan with one measurable step to move a key intention forward in the next week.',
        reversed: 'Scattered energies, misuse of skill, or doubt about personal power.'
      },
      {
        name: 'The High Priestess', emoji: 'üåô', meaning: 'Intuition, sacred knowledge, divine feminine, subconscious',
        detail: 'The High Priestess points inward; she asks you to honor dreams, symbolism, and quiet knowing. Information may be incomplete ‚Äî so cultivate patience and listen. Practical suggestion: keep a dream or intuition journal for a week and note recurring images.',
        reversed: 'Blocked intuition, withheld information, or confusion beneath the surface.'
      },
      {
        name: 'The Empress', emoji: 'üëë', meaning: 'Femininity, beauty, nature, nurturing, abundance',
        detail: 'The Empress embodies creative fertility and the pleasure of the senses. She suggests tending to projects and relationships with generosity and care. Consider where you can create supportive conditions rather than forcing outcomes. Advice: nurture one personal project like you would tend a garden.',
        reversed: 'Creative blocks, neglect, or overbearing caretaking that stifles growth.'
      },
      {
        name: 'The Emperor', emoji: '‚öîÔ∏è', meaning: 'Authority, structure, control, fatherhood',
        detail: 'The Emperor represents structure, boundaries, and leadership. When he appears, consider what systems you need to hold to realize long-term goals: scheduling, contracts, financial plans. Action: set one clear boundary or system that protects your time for the next month.',
        reversed: 'Rigidity, authoritarian behavior, or insecurity hidden beneath sternness.'
      },
      {
        name: 'The Hierophant', emoji: 'üìø', meaning: 'Spiritual wisdom, tradition, conformity, morality',
        detail: 'The Hierophant highlights learning from established wisdom, mentors, or ritual. It can signal formal study, initiation, or the need to align with communal practice. Practical note: seek a mentor or a trusted text rather than reinventing the wheel.',
        reversed: 'Questioning tradition, finding personal path outside prescribed systems.'
      },
      {
        name: 'The Lovers', emoji: 'üíï', meaning: 'Love, harmony, relationships, choices, values',
        detail: 'Beyond romance, The Lovers examines values and meaningful choices. It asks: where are you making decisions from love versus obligation? Action: identify one choice where your values should guide you more clearly.',
        reversed: 'Misalignment of values, indecision, or unhealthy attachment.'
      },
      {
        name: 'The Chariot', emoji: 'üèá', meaning: 'Control, willpower, success, determination, action',
        detail: 'The Chariot rewards focused ambition and disciplined pursuit. It suggests harnessing opposing forces toward a common direction. Tactic: break your goal into two immediate milestones and commit to the first one this week.',
        reversed: 'Loss of direction, scattered energy, or overcontrol.'
      },
      {
        name: 'Strength', emoji: 'ü¶Å', meaning: 'Inner strength, courage, patience, compassion',
        detail: 'Strength teaches gentle courage ‚Äî patience, compassion, and steady endurance rather than force. It encourages mastery over inner impulses through kindness to yourself. Practice: respond to a difficult situation with a calm breath and measured language.',
        reversed: 'Self-doubt, impulsivity, or lack of compassion toward self or others.'
      },
      {
        name: 'The Hermit', emoji: 'üïØÔ∏è', meaning: 'Soul searching, introspection, inner guidance, solitude',
        detail: 'The Hermit calls for withdrawal to read your inner map. Retreat and study yield clarity now. Recommendation: schedule a short solitude session to journal about the questions that matter most to you.',
        reversed: 'Loneliness, avoidance, or an inability to integrate insights gained in isolation.'
      },
      {
        name: 'Wheel of Fortune', emoji: 'üé°', meaning: 'Change, cycles, fate, turning point, destiny',
        detail: 'The Wheel reminds you that change is inherent. It signals a pivot, sometimes beyond your control. Use this time to adjust expectations rather than resist the tide. Tip: inventory what elements of a situation you can influence and what you must adapt to.',
        reversed: 'Resistance to change, stuck cycles, or poor timing.'
      },
      {
        name: 'Justice', emoji: '‚öñÔ∏è', meaning: 'Fairness, truth, cause and effect, law',
        detail: 'Justice asks for integrity and measured judgement. Decisions require clarity of motive and fairness. If facing legal or contractual matters, attend to details and seek impartial counsel.',
        reversed: 'Bias, denial of responsibility, or unresolved consequences.'
      },
      {
        name: 'The Hanged Man', emoji: 'üôÉ', meaning: 'Suspension, restriction, letting go, sacrifice',
        detail: 'The Hanged Man indicates a voluntary pause: a reorientation that opens new perspective. Rather than forcing action, hold still and look sideways. Reflect: what can you sacrifice now to gain clearer vision later?',
        reversed: 'Resistance to necessary pause or needless stalling.'
      },
      {
        name: 'Death', emoji: 'üíÄ', meaning: 'Endings, transformation, transition, release',
        detail: 'Death speaks to endings that clear the ground for regeneration. Expect significant transition and the need to grieve losses that make space for fresh life. Practical step: identify one habit to ceremonially release.',
        reversed: 'Fear of change, clinging to old forms, or delayed transformation.'
      },
      {
        name: 'Temperance', emoji: '‚öóÔ∏è', meaning: 'Balance, moderation, patience, purpose, meaning',
        detail: 'Temperance invites integration and patient blending of opposites. Seek sensible compromise and steady moderation. Exercise: harmonize one conflicting priority rather than amplify it.',
        reversed: 'Excess, impatience, or mismatched blending that lacks cohesion.'
      },
      {
        name: 'The Devil', emoji: 'üòà', meaning: 'Bondage, addiction, materialism, playfulness',
        detail: 'The Devil confronts attachments ‚Äî the chains we often accept as comforts. Identify dependencies and shine light on how they limit agency. Action: name one dependency and a small first step to loosen it.',
        reversed: 'Breaking free from limiting patterns or recognition of shadow influences.'
      },
      {
        name: 'The Tower', emoji: 'üè∞', meaning: 'Sudden change, upheaval, chaos, revelation, awakening',
        detail: 'The Tower represents an abrupt dismantling of false structures. Though disorienting, this purge reveals truth and clears space for more authentic foundations. Prepare by focusing on essentials and supportive relationships.',
        reversed: 'Avoided disaster or lingering shock from an event that should have catalyzed change.'
      },
      {
        name: 'The Star', emoji: '‚≠ê', meaning: 'Hope, faith, purpose, renewal, spirituality',
        detail: 'The Star brings restorative light and renewed faith. It suggests healing and reconnection to purpose. Practice gratitude and allow small acts of hope to guide daily choices.',
        reversed: 'Loss of faith, discouragement, or blocked healing.'
      },
      {
        name: 'The Moon', emoji: 'üåï', meaning: 'Illusion, fear, anxiety, subconscious, intuition',
        detail: 'The Moon navigates shadows: illusions, anxieties, and deep intuition. Not everything is as it appears; careful discernment and dreamwork help clarify. Exercise: notice where fear is shaping decisions and interrogate its origin.',
        reversed: 'Emerging clarity, dispelled illusions, or confronted fears.'
      },
      {
        name: 'The Sun', emoji: '‚òÄÔ∏è', meaning: 'Joy, success, celebration, positivity, vitality',
        detail: 'The Sun gifts clarity, vitality, and visible success. It invites celebration and wholehearted engagement with life. Advice: embrace simple pleasures and share gratitude with someone close.',
        reversed: 'Temporary setbacks, false brightness, or pride overshadowing genuine joy.'
      },
      {
        name: 'Judgement', emoji: 'üé∫', meaning: 'Reflection, reckoning, inner calling, absolution',
        detail: 'Judgement signals a moral reckoning and the chance for rebirth through honest evaluation. Take stock of past actions and forgive where possible to move forward renewed.',
        reversed: 'Self-doubt, avoidance of accountability, or unwillingness to change.'
      },
      {
        name: 'The World', emoji: 'üåç', meaning: 'Completion, accomplishment, travel, fulfillment',
        detail: 'The World marks completion and the harvest of efforts. Celebrate accomplishments and allow closure before embarking on new cycles. Consider a ritual to honor what you have finished.',
        reversed: 'Unfinished business or delayed recognition of achievement.'
      }
    ];

    // Suits and tone for Minor Arcana
    const suits = [
      {name:'Wands', emoji:'üî•', domain:'will, inspiration, enterprise', tone: 'fiery urgency and creative impulse'},
      {name:'Cups', emoji:'üíß', domain:'heart, relationship, empathy', tone: 'fluid emotion and intimate nuance'},
      {name:'Swords', emoji:'üí®', domain:'mind, truth, conflict', tone: 'sharp clarity and decisive thought'},
      {name:'Pentacles', emoji:'üåø', domain:'body, craft, provision', tone: 'earthly steadiness and material craft'}
    ];

    // Rank templates with more in-depth guidance and reflective prompts
    const rankTemplates = {
      'Ace': {
        upright: 'A concentrated spark of the suit: a clear opportunity, the germ of intent, or a new resource arriving.',
        reversed: 'Potential not yet realized or fear delaying actualization.',
        advice: 'Ask: where is a single decisive action you can take to begin this influence?'
      },
      'Two': {
        upright: 'A pairing, invitation to diplomacy, or a choice that frames a path forward.',
        reversed: 'Indecision, imbalance or a partnership that has unclear terms.',
        advice: 'Weigh pros and cons in writing; speak with the other party for clarity.'
      },
      'Three': {
        upright: 'The first collaborative outcomes or signs your initiative bears fruit.',
        reversed: 'Early friction, miscommunication, or misplaced expectations.',
        advice: 'Attend to communication and clarify roles to stabilize growth.'
      },
      'Four': {
        upright: 'Consolidation ‚Äî a moment to secure what you‚Äôve built and create sustainable rhythms.',
        reversed: 'Complacency or a rigid comfort that blocks future expansion.',
        advice: 'Practice tiny changes that ease you out of complacency without breaking stability.'
      },
      'Five': {
        upright: 'Conflict, challenge, or material disturbance that forces adaptation.',
        reversed: 'Avoided confrontation that accumulates into resentment.',
        advice: 'Name the real issue and resolve one small point to reduce friction.'
      },
      'Six': {
        upright: 'A welcome return, aid, or restoration of balance after struggle.',
        reversed: 'Clinging to the past or immature reconciliation.',
        advice: 'Offer or accept help that genuinely advances recovery.'
      },
      'Seven': {
        upright: 'A defensive posture, strategy, or quiet persistence through testing times.',
        reversed: 'Paranoia or misapplied caution that stops progress.',
        advice: 'Reassess your assumptions and consider a more open strategy.'
      },
      'Eight': {
        upright: 'Momentum, swift developments, or messages that accelerate change.',
        reversed: 'Overwhelm or stalled movement due to poor direction.',
        advice: 'Focus one channel of effort rather than multiplying attempts.'
      },
      'Nine': {
        upright: 'The threshold before completion ‚Äî refinement, resilience, and near-mastery.',
        reversed: 'Weariness, anxiety about last steps, or perfectionism.',
        advice: 'Take a restorative pause and reframe success in smaller terms.'
      },
      'Ten': {
        upright: 'Full consequence ‚Äî inheritance or burden that arrives from previous labor.',
        reversed: 'Collapse, burnout, or the need to release an unsustainable load.',
        advice: 'Delegate or offload one responsibility to regain balance.'
      },
      'Page': {
        upright: 'A curious messenger or an inexperienced but important influence entering the scene.',
        reversed: 'Naivety, heedless messages, or immature expression of the suit.',
        advice: 'Treat incoming news gently; verify before acting.'
      },
      'Knight': {
        upright: 'A dedicated agent of the suit acting with vigor and confidence.',
        reversed: 'Impulsiveness or misdirected energy; a rush without enough planning.',
        advice: 'Temper haste with a quick checklist to avoid mistakes.'
      },
      'Queen': {
        upright: 'Mature, empathetic stewardship of the suit‚Äôs domain; skilled and steady influence.',
        reversed: 'Smothering control or neglect of inner needs while tending others.',
        advice: 'Set boundaries to preserve your capacity to serve others sustainably.'
      },
      'King': {
        upright: 'Authority and skilled mastery applied with responsibility.',
        reversed: 'Abuse of power or inflexibility; leadership lacking heart.',
        advice: 'Lead with a small act of generosity to re-center authority.'
      }
    };

    // Build minor arcana with expanded detail, advice, and reflective prompt
    function buildMinorArcana(){
      const arr = [];
      for(const s of suits){
        for(const rank of Object.keys(rankTemplates)){
          const name = `${rank} of ${s.name}`;
          const tpl = rankTemplates[rank];
          const detail = `${tpl.upright} Within ${s.name.toLowerCase()} matters, this speaks to ${s.tone}. ${tpl.advice} Consider: ${generateReflectionQuestion(rank, s.name)}`
          const reversed = tpl.reversed + ` In ${s.name.toLowerCase()} contexts, this warns against the shadow side of the ${rank.toLowerCase()}.`
          arr.push({name, emoji: s.emoji, meaning:`${s.tone} ‚Äî ${tpl.upright}`, detail, suit: s.name, rank, reversed});
        }
      }
      return arr;
    }

    function generateReflectionQuestion(rank, suit){
      // short, evocative reflective prompts
      return (rank + ' of ' + suit).length % 2 === 0
        ? `What small intentional act moves this energy forward?`
        : `Who around you amplifies or dampens this influence?`;
    }

    const minorArcana = buildMinorArcana();

    // --- UI & state ---
    let currentSpread = 'single';
    let readingCount = 0;
    let foolMode = false;

    const cardsContainer = document.getElementById('cardsContainer');
    const interpretation = document.getElementById('interpretation');
    const drawBtn = document.getElementById('drawBtn');
    const includeMinorToggle = document.getElementById('includeMinor');
    const showReversalsToggle = document.getElementById('showReversals');
    const enableSoundToggle = document.getElementById('enableSound');
    const foolCanvas = document.getElementById('foolCanvas');
    const ctx = foolCanvas.getContext && foolCanvas.getContext('2d');

    function resizeCanvas(){
      foolCanvas.width = innerWidth * devicePixelRatio;
      foolCanvas.height = innerHeight * devicePixelRatio;
      foolCanvas.style.width = innerWidth + 'px';
      foolCanvas.style.height = innerHeight + 'px';
      ctx && ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Spread selector
    document.querySelectorAll('.spread-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.spread-card').forEach(c => {
          c.classList.remove('active');
          c.setAttribute('aria-selected','false');
        });
        card.classList.add('active');
        card.setAttribute('aria-selected','true');
        currentSpread = card.dataset.spread;
        cardsContainer.innerHTML = '';
        interpretation.classList.remove('show');
      });
    });

    function buildPool(){
      let pool = [...majorArcana];
      if(includeMinorToggle.checked) pool = pool.concat(minorArcana);
      return pool;
    }

    function drawCardFromPool(pool, forceFool=false, allowReversal=true){
      if(forceFool) return {...majorArcana[0], reversed:false};
      const idx = Math.floor(Math.random() * pool.length);
      const card = pool[idx];
      const reversed = allowReversal && Math.random() < 0.35;
      return {...card, reversed};
    }

    // svg art placeholder
    function svgArtFor(name, accentHue=260){
      const seed = [...name].reduce((s,c)=>s + c.charCodeAt(0), 0);
      const hue = (accentHue + (seed % 60)) % 360;
      const svg =
        `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 200' preserveAspectRatio='xMidYMid slice'>
          <defs>
            <linearGradient id='g${seed}' x1='0' x2='1'>
              <stop offset='0' stop-color='hsl(${hue},78%,62%)'/>
              <stop offset='1' stop-color='hsl(${(hue+40)%360},68%,44%)'/>
            </linearGradient>
          </defs>
          <rect width='100%' height='100%' rx='12' fill='url(#g${seed})'/>
          <g transform='translate(200,100)'>
            <circle r='62' fill='rgba(255,255,255,0.04)'/>
            <path d='M-48 16 C-28 36, 28 36, 48 16' stroke='rgba(255,255,255,0.12)' stroke-width='6' fill='none' stroke-linecap='round'/>
            <text x='0' y='12' font-family='Cinzel, serif' font-size='44' fill='rgba(255,255,255,0.9)' text-anchor='middle'>${name.split(' ').map(n=>n[0]||'').slice(0,2).join('')}</text>
          </g>
        </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    function enableTilt(cardEl){
      const inner = cardEl.querySelector('.card-inner');
      cardEl.addEventListener('mousemove', (e) => {
        const r = cardEl.getBoundingClientRect();
        const px = (e.clientX - r.left) / r.width;
        const py = (e.clientY - r.top) / r.height;
        const rx = (py - 0.5) * -10;
        const ry = (px - 0.5) * 10;
        inner.style.transform = `rotateY(${ry}deg) rotateX(${rx}deg) ${cardEl.classList.contains('flipped') ? 'rotateY(180deg)' : ''}`;
      });
      cardEl.addEventListener('mouseleave', () => {
        inner.style.transform = cardEl.classList.contains('flipped') ? 'rotateY(180deg)' : 'none';
      });
    }

    // WebAudio chime
    function playChime(type='soft'){
      if(!enableSoundToggle.checked || !window.AudioContext) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const now = ctx.currentTime;
        if(type === 'fool'){
          const freqs = [220, 266.5, 311.1];
          freqs.forEach((f,i) => {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = 'sine';
            o.frequency.setValueAtTime(f, now);
            o.connect(g);
            g.connect(ctx.destination);
            g.gain.setValueAtTime(0.0001, now);
            g.gain.exponentialRampToValueAtTime(0.12/(i+1), now+0.02);
            g.gain.exponentialRampToValueAtTime(0.0001, now+1.2);
            o.start(now);
            o.stop(now+1.25);
          });
        } else {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          o.frequency.setValueAtTime(660, now);
          o.connect(g); g.connect(ctx.destination);
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.12, now+0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now+1.0);
          o.start(now); o.stop(now+1.1);
        }
      } catch(e){ /* fail silently */ }
    }

    // particles for fool mode
    const particles = [];
    function spawnParticles(){
      particles.length = 0;
      for(let i=0;i<80;i++){
        particles.push({
          x: Math.random()*innerWidth,
          y: Math.random()*innerHeight,
          vx: (Math.random()-0.5)*0.7,
          vy: (Math.random()-0.5)*0.7 - 0.2,
          size: 1 + Math.random()*3,
          hue: 260 + Math.random()*120,
          life: 60 + Math.random()*160
        });
      }
    }
    let particleAnimId = null;
    function animateParticles(){
      if(!ctx) return;
      ctx.clearRect(0,0,foolCanvas.width, foolCanvas.height);
      const dpr = devicePixelRatio || 1;
      ctx.save();
      ctx.scale(dpr,dpr);
      particles.forEach((p) => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.002;
        p.life--;
        const alpha = Math.max(0, Math.min(1, p.life/180));
        ctx.beginPath();
        ctx.fillStyle = `hsla(${p.hue},85%,62%,${alpha*0.85})`;
        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fill();
        if(p.life <= 0){
          p.x = Math.random()*innerWidth;
          p.y = innerHeight + 10;
          p.vx = (Math.random()-0.5)*0.7;
          p.vy = -(0.6+Math.random()*1.2);
          p.life = 60 + Math.random()*180;
        }
      });
      ctx.restore();
      particleAnimId = requestAnimationFrame(animateParticles);
    }
    function startFoolCanvas(){ spawnParticles(); if(particleAnimId==null) animateParticles(); foolCanvas.style.display = 'block'; }
    function stopFoolCanvas(){ foolCanvas.style.display = 'none'; if(particleAnimId!=null){ cancelAnimationFrame(particleAnimId); particleAnimId = null; } ctx && ctx.clearRect(0,0,foolCanvas.width,foolCanvas.height); }

    function showCardDetail(card){
      const revNote = card.reversed ? `<p style="margin-top:8px;color:var(--muted)"><strong>Reversed:</strong> ${card.reversed}</p>` : '';
      interpretation.innerHTML = `
        <h2>üîé ${card.name}</h2>
        <div class="card-detail">
          <h3>${card.emoji} ${card.position || ''}</h3>
          <p>${card.detail}</p>
          ${revNote}
        </div>
      `;
      interpretation.classList.add('show');
      interpretation.scrollIntoView({behavior:'smooth', block:'center'});
    }

    // Lowered/adjusted probability per your request: ~10% chance
    drawBtn.addEventListener('click', () => {
      readingCount++;
      const foolProbability = 0.10; // ~10% chance
      const shouldActivateFool = Math.random() < foolProbability;
      foolMode = shouldActivateFool;

      const pool = buildPool();
      cardsContainer.innerHTML = '';
      interpretation.innerHTML = '';
      interpretation.classList.remove('show');

      let numCards, positions;
      if(currentSpread === 'single'){ numCards = 1; positions = ['Your Answer']; }
      else if(currentSpread === 'three'){ numCards = 3; positions = ['Past', 'Present', 'Future']; }
      else { numCards = 5; positions = ['Present', 'Challenge', 'Past', 'Future', 'Outcome']; }

      playChime(foolMode ? 'fool' : 'soft');
      if(foolMode) startFoolCanvas(); else stopFoolCanvas();

      // draw
      const drawn = [];
      for(let i=0;i<numCards;i++){
        const card = drawCardFromPool(pool, foolMode, showReversalsToggle.checked);
        drawn.push({...card, position: positions[i] || `Pos ${i+1}`});
      }

      // render cards (staggered)
      drawn.forEach((card, idx) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'tarot-card';
        cardEl.setAttribute('tabindex','0');

        const reversedBadge = card.reversed ? `<div class="reversed-indicator">‚Ü∑ Reversed</div>` : '';
        const frontClass = foolMode ? 'fool-mode' : '';
        const svgUri = svgArtFor(card.name, 260 + (card.name.length % 90));

        cardEl.innerHTML = `
          <div class="card-inner">
            <div class="card-face card-back" aria-hidden="true">
              <div class="sigil" aria-hidden="true">
                <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
                  <defs><linearGradient id="sg1" x1="0" x2="1"><stop offset="0" stop-color="rgba(255,255,255,0.09)"/><stop offset="1" stop-color="rgba(255,255,255,0.02)"/></linearGradient></defs>
                  <rect width="120" height="120" rx="10" fill="url(#sg1)"/>
                  <g transform="translate(60,60)"><circle r="30" fill="rgba(255,255,255,0.03)"/><path d="M-22 10 C-5 28, 5 28, 22 10" stroke="rgba(255,255,255,0.07)" stroke-width="2" fill="none" stroke-linecap="round"/><text x="0" y="6" font-family="Cinzel, serif" font-size="22" fill="rgba(255,255,255,0.12)" text-anchor="middle">${card.name.split(' ').map(x=>x[0]||'').slice(0,2).join('')}</text></g>
                </svg>
              </div>
            </div>
            <div class="card-face card-front ${frontClass}">
              ${reversedBadge}
              <div class="card-art"><img src="${svgUri}" alt="${card.name} art" /></div>
              <div class="card-emoji">${card.emoji || ''}</div>
              <div class="card-name">${card.name}</div>
              <div class="card-meaning">${card.meaning}</div>
            </div>
          </div>
        `;

        setTimeout(() => {
          cardsContainer.appendChild(cardEl);
          enableTilt(cardEl);
          setTimeout(() => cardEl.classList.add('flipped'), 90);
          cardEl._card = card;
          cardEl.addEventListener('click', () => showCardDetail(cardEl._card));
          cardEl.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showCardDetail(cardEl._card); }
          });
        }, idx * 240);
      });

      // interpretation panel
      setTimeout(() => {
        if(foolMode){
          interpretation.innerHTML = `
            <div class="praise">üÉè THE FOOL'S BLESSING</div>
            <p style="text-align:center; font-size:16px; color:var(--muted); font-style:italic;">
              The Fool tugs a corner of the veil. Expect ciphers, orders, and motifs repeating like ritual marks ‚Äî an atmosphere reminiscent of hidden societies and arcane dossiers.
            </p>
            <div class="card-detail">
              <h3>üîÆ The Fool as Cipher</h3>
              <p>The Fool reframes events as possible signs and signals. Where coincidence looked comfortable, look for protocol and repetition. Practically, jot recurring symbols and names for later pattern-matching. This blessing is an invitation to treat life as text with encoded margins.</p>
            </div>
            <div class="card-detail">
              <h3>üïØÔ∏è How to Use this Reading</h3>
              <p>Keep a small motif log, note dates and places where a symbol recurs, and consider how these motifs might map onto decisions you make. The Fool amplifies curiosity and skepticism in equal measure.</p>
            </div>
          `;
        } else {
          let html = '<h2>‚ú® Your Reading</h2>';
          drawn.forEach(card => {
            html += `
              <div class="card-detail">
                <h3>${card.emoji} ${card.position || ''}: ${card.name}</h3>
                <p>${card.detail}</p>
                ${card.reversed ? `<p style="margin-top:8px;color:var(--muted)"><strong>Reversed:</strong> ${card.reversed}</p>` : ''}
              </div>
            `;
          });
          interpretation.innerHTML = html;
        }
        interpretation.classList.add('show');
        interpretation.setAttribute('tabindex','-1');
        interpretation.focus({preventScroll:true});
      }, numCards * 280 + 420);
    });

    // initial hint
    setTimeout(() => {
      const hint = document.createElement('div');
      hint.className = 'control';
      hint.style.margin = '10px auto';
      hint.style.textAlign = 'center';
      hint.textContent = 'Tip: Toggle Minor Arcana to expand the deck. Click any card for an expanded interpretation.';
      document.querySelector('.container').insertBefore(hint, document.querySelector('.container').children[4]);
      setTimeout(()=>hint.remove(), 10000);
    }, 700);

    // ensure canvas starts hidden
    stopFoolCanvas();
  </script>
</body>
</html>

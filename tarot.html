<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f0f13" />
  <title>Arcane Divination ¬∑ Tarot Reading (Upgraded)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0a0612;
      --panel: #120a1f;
      --muted: #9b8fb8;
      --text: #e8e4f0;
      --brand: #d946ef;
      --brand-2: #f59e0b;
      --accent: #10b981;
      --ring: 0 0 0 2px rgba(217,70,239,.35);
      --shadow: 0 10px 40px rgba(217,70,239,.25);
      --glow: 0 0 20px rgba(217,70,239,.4);
      --glass: rgba(139,92,246,.08);
      --glass-brd: rgba(139,92,246,.25);
    }
    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%}
    body{
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(ellipse 1400px 900px at 90% -15%, rgba(217,70,239,.18), transparent 55%),
        radial-gradient(ellipse 1000px 700px at 10% 100%, rgba(245,158,11,.15), transparent 50%),
        var(--bg);
      color:var(--text); line-height:1.6; letter-spacing:.2px;
      background-attachment: fixed; padding:20px;
      overflow-x:hidden;
    }

    .container{max-width:960px; margin:0 auto; position:relative; z-index:2}

    .header{text-align:center; padding:36px 20px 6px}
    .header h1{
      font-family:'Cinzel', serif; font-size:clamp(32px, 5vw, 48px);
      background:linear-gradient(120deg, var(--brand), var(--brand-2), var(--accent));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      margin-bottom:6px; font-weight:900;
    }
    .header p{color:var(--muted); font-size:15px}

    .back-btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 16px;
      background:var(--glass); border:1px solid var(--glass-brd); border-radius:12px;
      color:var(--text); text-decoration:none; transition:all .2s ease;
      font-weight:500; margin-bottom:18px;
    }
    .back-btn:hover{border-color:var(--brand); transform:translateY(-2px); box-shadow:var(--shadow)}

    .reading-selector{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
      gap:14px; margin:22px 0;
    }
    .spread-card{
      background:linear-gradient(135deg, rgba(139,92,246,.08), rgba(245,158,11,.06));
      border:1px solid var(--glass-brd); border-radius:16px; padding:20px;
      cursor:pointer; transition:all .25s ease; text-align:center;
      user-select:none;
    }
    .spread-card:hover{
      transform:translateY(-4px); border-color:var(--brand);
      box-shadow:0 12px 36px rgba(217,70,239,.32);
    }
    .spread-card.active{
      border-color:var(--brand); background:linear-gradient(135deg, rgba(139,92,246,.15), rgba(245,158,11,.08));
    }
    .spread-icon{font-size:44px; margin-bottom:10px}
    .spread-title{font-family:'Cinzel', serif; font-size:18px; font-weight:700; margin-bottom:6px}
    .spread-desc{font-size:13px; color:var(--muted)}

    .controls{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center;
      margin:6px 0 18px;
    }
    .control{
      background:var(--glass); border:1px solid var(--glass-brd); padding:8px 12px; border-radius:12px;
      color:var(--text); font-size:14px; display:flex; gap:8px; align-items:center;
    }
    .control input{transform:scale(1.1)}

    .btn{
      display:inline-flex; align-items:center; gap:10px; padding:14px 28px;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      border:none; border-radius:14px; color:#fff; font-size:16px;
      font-weight:600; cursor:pointer; transition:all .3s ease;
      box-shadow:var(--shadow); margin:20px auto; font-family:'Cinzel', serif;
    }
    .btn:hover{transform:translateY(-3px); box-shadow:0 15px 50px rgba(217,70,239,.5)}
    .btn:active{transform:translateY(-1px)}
    .btn:disabled{opacity:.5; cursor:not-allowed; transform:none}

    .cards-container{
      display:flex; justify-content:center; gap:18px; flex-wrap:wrap;
      margin:30px 0; min-height:360px; align-items:center;
    }

    .tarot-card{
      width:170px; height:270px; perspective:1100px; cursor:pointer; position:relative;
      transition:transform .15s ease;
    }
    .card-inner{
      width:100%; height:100%; position:relative; transition:transform .8s; transform-style:preserve-3d;
      will-change:transform;
      border-radius:14px;
    }
    .tarot-card.flipped .card-inner{transform:rotateY(180deg)}
    
    .card-face{
      position:absolute; width:100%; height:100%; backface-visibility:hidden;
      border-radius:14px; display:flex; flex-direction:column; align-items:center;
      justify-content:center; padding:16px; border:2px solid var(--glass-brd);
      box-shadow:var(--shadow); overflow:hidden;
    }
    /* animated card-back with sigil rotate + shimmer */
    .card-back{
      background:
        radial-gradient(ellipse at 20% 10%, rgba(255,255,255,.03), transparent 12%),
        linear-gradient(135deg, rgba(139,92,246,.22), rgba(245,158,11,.14));
      backdrop-filter:blur(8px);
      display:flex; align-items:center; justify-content:center; font-size:64px; color:rgba(255,255,255,.12);
      position:relative; overflow:visible;
    }
    .card-back .sigil{
      width:86%; height:86%;
      border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(120deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      transform-origin:center center;
      animation:spinSigil 10s linear infinite;
      box-shadow: inset 0 0 18px rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.02);
    }
    .card-back .sigil svg{display:block; width:78%; height:78%}
    @keyframes spinSigil{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    .card-back::after{
      content:''; position:absolute; left:-20%; top:-30%; width:180%; height:160%;
      background:linear-gradient(90deg, rgba(255,255,255,.02), rgba(255,255,255,0), rgba(255,255,255,.02));
      transform: skewX(-18deg);
      animation:shimmer 3.4s linear infinite;
      pointer-events:none; opacity:.7;
    }

    .card-front{
      background:linear-gradient(135deg, var(--panel), rgba(18,10,31,.95));
      transform:rotateY(180deg); text-align:center; padding:12px;
      display:flex; flex-direction:column; justify-content:flex-start; gap:8px;
    }
    .card-emoji{font-size:46px; margin-top:8px}
    .card-art{width:100%; height:110px; display:flex; align-items:center; justify-content:center; border-radius:10px; overflow:hidden; margin-top:6px}
    .card-art svg{width:100%; height:100%}
    .card-name{
      font-family:'Cinzel', serif; font-size:15px; font-weight:700;
      margin-bottom:2px; color:var(--brand-2);
    }
    .card-meaning{font-size:12px; color:var(--muted); line-height:1.4}

    .reversed-indicator{
      position:absolute; top:8px; right:8px; font-size:12px; background:rgba(0,0,0,.35);
      padding:6px 8px; border-radius:999px; color:var(--brand-2); border:1px solid rgba(255,255,255,.04);
      font-weight:700;
    }

    .interpretation{
      background:linear-gradient(135deg, rgba(139,92,246,.12), rgba(245,158,11,.1));
      border:1px solid var(--glass-brd); border-radius:18px; padding:26px;
      margin:28px 0; backdrop-filter:blur(8px); box-shadow:var(--shadow);
      opacity:0; transform:translateY(20px); transition:all .6s ease;
    }
    .interpretation.show{opacity:1; transform:translateY(0)}
    .interpretation h2{
      font-family:'Cinzel', serif; font-size:22px; margin-bottom:14px;
      color:var(--brand-2);
    }
    .card-detail{
      margin:16px 0; padding:16px; background:rgba(0,0,0,.18);
      border-radius:10px; border-left:4px solid var(--brand);
    }
    .card-detail h3{
      font-family:'Cinzel', serif; font-size:16px; color:var(--brand);
      margin-bottom:8px; display:flex; align-items:center; gap:10px;
    }
    .card-detail p{color:var(--text); line-height:1.6}

    .fool-mode{
      background:linear-gradient(135deg, rgba(239,68,68,.15), rgba(217,70,239,.15)) !important;
      border-color:rgba(239,68,68,.5) !important;
      animation:foolPulse 2s infinite;
    }
    @keyframes foolPulse{
      0%, 100%{box-shadow:0 0 24px rgba(239,68,68,.28)}
      50%{box-shadow:0 0 44px rgba(239,68,68,.55), 0 0 60px rgba(217,70,239,.38)}
    }

    .praise{
      font-size:clamp(22px, 4vw, 32px); font-family:'Cinzel', serif;
      text-align:center; font-weight:900; margin:30px 0;
      background:linear-gradient(90deg, #ef4444, #d946ef, #f59e0b);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation:shimmer 3s infinite;
    }

    #foolCanvas{
      position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:1; mix-blend-mode:screen;
    }

    @media (max-width: 640px){
      .cards-container{gap:12px}
      .tarot-card{width:150px; height:240px}
      .spread-icon{font-size:36px}
    }
  </style>
</head>
<body>
  <canvas id="foolCanvas" aria-hidden="true"></canvas>
  <div class="container" id="app">
    <a href="index.html" class="back-btn">‚Üê Return to Grimoire</a>
    
    <div class="header">
      <h1>üîÆ Arcane Divination</h1>
      <p>Let the mystical cards reveal your destiny</p>
    </div>

    <div class="reading-selector" role="tablist">
      <div class="spread-card active" data-spread="single" role="tab" aria-selected="true">
        <div class="spread-icon">üÉè</div>
        <div class="spread-title">Single Card</div>
        <div class="spread-desc">Quick insight into your question</div>
      </div>
      <div class="spread-card" data-spread="three" role="tab">
        <div class="spread-icon">üé¥</div>
        <div class="spread-title">Three Card</div>
        <div class="spread-desc">Past, Present, Future</div>
      </div>
      <div class="spread-card" data-spread="celtic" role="tab">
        <div class="spread-icon">‚ú®</div>
        <div class="spread-title">Celtic Cross</div>
        <div class="spread-desc">Deep, comprehensive reading (simplified)</div>
      </div>
    </div>

    <div class="controls" aria-hidden="false">
      <label class="control"><input type="checkbox" id="includeMinor"> Include Minor Arcana</label>
      <label class="control"><input type="checkbox" id="showReversals" checked> Allow Reversals</label>
      <label class="control"><input type="checkbox" id="enableSound"> Ambient Sound</label>
    </div>

    <center>
      <button class="btn" id="drawBtn">‚ú® Divine Your Fate ‚ú®</button>
    </center>

    <div class="cards-container" id="cardsContainer" aria-live="polite"></div>
    <div class="interpretation" id="interpretation" aria-live="polite"></div>
  </div>

  <script>
    /*
      Upgrades implemented in this file:
      1) Artwork placeholders + animated card back (rotating sigil).
      2) Handcrafted minor-arcana meanings (constructed from curated rank+ suit templates).
      3) Stronger "Lord of the Mysteries" flavored Fool's Blessing text (homage, not quotes).
      4) Reduced probability of Fool's Blessing (rare).
      5) Small UX improvements: click-to-open card detail, tilt effect, keyboard accessibility, audio option.
    */

    // ========== Major Arcana (unchanged content but with reversed fields added) ==========
    const majorArcana = [
      {name: 'The Fool', emoji: 'üÉè', meaning: 'New beginnings, innocence, spontaneity, free spirit', detail: 'The Fool represents the beginning of a journey, embracing the unknown with courage and optimism. It speaks of taking risks and trusting in the universe.', reversed: 'Recklessness, naivety, holding back from a new start.'},
      {name: 'The Magician', emoji: 'üé©', meaning: 'Manifestation, resourcefulness, power, inspired action', detail: 'The Magician harnesses the elements. You have the tools to craft change; focus your will and move.', reversed: 'Scattered energies, untapped potential, manipulation.'},
      {name: 'The High Priestess', emoji: 'üåô', meaning: 'Intuition, sacred knowledge, divine feminine, subconscious', detail: 'Trust your inner voice. Secrets are present; pay attention to dreams and omens.', reversed: 'Blocked intuition, secrets withheld, confusion.'},
      {name: 'The Empress', emoji: 'üëë', meaning: 'Femininity, beauty, nature, nurturing, abundance', detail: 'Creativity, fertility, and the nourishing side of life. Tend and grow your projects.', reversed: 'Smothering, creative blocks, neglect.'},
      {name: 'The Emperor', emoji: '‚öîÔ∏è', meaning: 'Authority, structure, control, fatherhood', detail: 'Leadership and foundations. Apply discipline and set boundaries.', reversed: 'Rigidity, abuse of power, insecurity.'},
      {name: 'The Hierophant', emoji: 'üìø', meaning: 'Spiritual wisdom, tradition, conformity, morality', detail: 'Seek guidance from mentors and institutions; learning is highlighted.', reversed: 'Question authority, break tradition, find personal meaning.'},
      {name: 'The Lovers', emoji: 'üíï', meaning: 'Love, harmony, relationships, choices, values', detail: 'Connections and choices‚Äîalign heart and mind when deciding.', reversed: 'Imbalance, misaligned values, difficult choices.'},
      {name: 'The Chariot', emoji: 'üèá', meaning: 'Control, willpower, success, determination, action', detail: 'Victory through focus and discipline. Keep the reins steady.', reversed: 'Lack of direction, scattered will, obstacles.'},
      {name: 'Strength', emoji: 'ü¶Å', meaning: 'Inner strength, courage, patience, compassion', detail: 'Compassion and quiet courage will triumph where force fails.', reversed: 'Self-doubt, weakness, impatience.'},
      {name: 'The Hermit', emoji: 'üïØÔ∏è', meaning: 'Soul searching, introspection, inner guidance, solitude', detail: 'Withdraw to find inner truth and wise counsel.', reversed: 'Loneliness, avoidance, refusal to look inward.'},
      {name: 'Wheel of Fortune', emoji: 'üé°', meaning: 'Change, cycles, fate, turning point, destiny', detail: 'Cycles and tides‚Äîprepare for a turning point.', reversed: 'Resisting change, bad timing, repeated patterns.'},
      {name: 'Justice', emoji: '‚öñÔ∏è', meaning: 'Fairness, truth, cause and effect, law', detail: 'Balance and fairness will be sought; be honest in decisions.', reversed: 'Bias, injustice, denial of consequences.'},
      {name: 'The Hanged Man', emoji: 'üôÉ', meaning: 'Suspension, restriction, letting go, sacrifice', detail: 'Pause and surrender; see from a new angle.', reversed: 'Stagnation, needless sacrifice, refusal to yield.'},
      {name: 'Death', emoji: 'üíÄ', meaning: 'Endings, transformation, transition, release', detail: 'Endings that clear the way for renewal and transformation.', reversed: 'Resistance to change, delayed endings.'},
      {name: 'Temperance', emoji: '‚öóÔ∏è', meaning: 'Balance, moderation, patience, purpose, meaning', detail: 'Blend and integrate ‚Äî balance is the path forward.', reversed: 'Extremes, impatience, imbalance.'},
      {name: 'The Devil', emoji: 'üòà', meaning: 'Bondage, addiction, materialism, playfulness', detail: 'Chains of habit and desire; name them and face them.', reversed: 'Breaking free, awareness, reclaiming power.'},
      {name: 'The Tower', emoji: 'üè∞', meaning: 'Sudden change, upheaval, chaos, revelation, awakening', detail: 'Cataclysmic revelation that clears falsehoods away.', reversed: 'Avoided disaster, delayed reckoning, lingering shock.'},
      {name: 'The Star', emoji: '‚≠ê', meaning: 'Hope, faith, purpose, renewal, spirituality', detail: 'Hope and healing are returning; breathe and trust.', reversed: 'Discouragement, lost faith, blocked renewal.'},
      {name: 'The Moon', emoji: 'üåï', meaning: 'Illusion, fear, anxiety, subconscious, intuition', detail: 'The subconscious stirs; use intuition to navigate shadows.', reversed: 'Clarity emerging, released fears, deception exposed.'},
      {name: 'The Sun', emoji: '‚òÄÔ∏è', meaning: 'Joy, success, celebration, positivity, vitality', detail: 'Joy and accomplishment shine bright; embrace warmth.', reversed: 'Temporary setback, muted joy, prideful arrogance.'},
      {name: 'Judgement', emoji: 'üé∫', meaning: 'Reflection, reckoning, inner calling, absolution', detail: 'A call to account; rebirth through honest reflection.', reversed: 'Self-doubt, refusal to forgive or move on.'},
      {name: 'The World', emoji: 'üåç', meaning: 'Completion, accomplishment, travel, fulfillment', detail: 'Cycle complete ‚Äî celebrate and open new chapters.', reversed: 'Unfinished business, delayed success.'}
    ];

    // ========== Handcrafted Minor Arcana construction ==========
    // Suit definitions with evocative descriptions:
    const suits = [
      {name:'Wands', emoji:'üî•', domain:'will, inspiration, enterprise', tone: 'fiery urgency and creative impulse'},
      {name:'Cups', emoji:'üíß', domain:'heart, relationship, empathy', tone: 'fluid emotion and intimate nuance'},
      {name:'Swords', emoji:'üí®', domain:'mind, truth, conflict', tone: 'sharp clarity and decisive thought'},
      {name:'Pentacles', emoji:'üåø', domain:'body, craft, provision', tone: 'earthly steadiness and material craft'}
    ];

    // Handcrafted rank templates (upright + reversed). Curated wording for ritualized flavor.
    const rankTemplates = {
      'Ace': {
        upright: 'A seed of potential; the first pulse of the suit‚Äôs energy manifests in a focused spark.',
        reversed: 'Blocked inception or a gift unrecognized; the seed waits for fertile ground.'
      },
      'Two': {
        upright: 'A partnership or crossroads; early balance between opposing forces begins to form.',
        reversed: 'A stalemate or misalignment of intentions; choices remain unsettled.'
      },
      'Three': {
        upright: 'The first fruits‚Äîcooperation after initiation creates visible growth.',
        reversed: 'Early discord or plans that lack cohesion; promised growth stalls.'
      },
      'Four': {
        upright: 'Foundations settle; a pause to consolidate gains and secure the structure.',
        reversed: 'Stagnation or comfort that prevents necessary progress.'
      },
      'Five': {
        upright: 'Conflict or necessary disturbance‚Äîold forms are tested to reveal truth.',
        reversed: 'Avoided confrontation that festers; a hidden upset.'
      },
      'Six': {
        upright: 'A return to harmony; assistance and small victories stabilize the path.',
        reversed: 'Clinging to past glories or an immature reconciliation.'
      },
      'Seven': {
        upright: 'Guarded stance‚Äîdefense, strategy, and perseverance in ongoing trials.',
        reversed: 'Paranoia, misapplied caution, or fear that becomes self-sabotage.'
      },
      'Eight': {
        upright: 'Acceleration‚Äîskills, messages, or movement gain momentum.',
        reversed: 'Overwhelm, misdirected haste, or stalled channels.'
      },
      'Nine': {
        upright: 'A near-completion; resiliency and final refinements before culmination.',
        reversed: 'Anxiety about completion or exhausted perseverance.'
      },
      'Ten': {
        upright: 'Full manifestation‚Äîthe weight of consequence and inheritance of labor.',
        reversed: 'Burnout, collapse of a structure, or release from burden.'
      },
      'Page': {
        upright: 'A messenger or novice who bears the suit‚Äôs message with curiosity.',
        reversed: 'Immaturity or missed signs; the courier misreads the runes.'
      },
      'Knight': {
        upright: 'A purposeful agent acting with the suit‚Äôs nature‚Äîbold, romantic, intellectual, or steady.',
        reversed: 'Folly in action: rashness, cruelty, or misapplied force.'
      },
      'Queen': {
        upright: 'Embodiment of mature trait‚Äînurturing leadership, empathy, or skilled oversight.',
        reversed: 'Smothering influence or a queen who has forgotten her domain.'
      },
      'King': {
        upright: 'Mastery and authority; the suit‚Äôs power used with stewardship and judgment.',
        reversed: 'Abuse of power, rigidity, or corrupted mastery.'
      }
    };

    // Build minor arcana list programmatically, but using the handcrafted templates above for detail
    function buildMinorArcana(){
      const arr = [];
      for(const s of suits){
        for(const rank of Object.keys(rankTemplates)){
          const name = `${rank} of ${s.name}`;
          const emoji = s.emoji;
          const tpl = rankTemplates[rank];
          const detail = `${tpl.upright} In the realm of ${s.domain}, this card emphasizes ${s.tone}.`;
          const reversed = tpl.reversed + ` In ${s.name.toLowerCase()} matters this warns against the shadow of the rank.`;
          arr.push({name, emoji, meaning: `${s.tone} ‚Äî ${tpl.upright}`, detail, suit: s.name, rank, reversed});
        }
      }
      return arr;
    }
    const minorArcana = buildMinorArcana();

    // ========== State & UI refs ==========
    let currentSpread = 'single';
    let readingCount = 0;
    let foolMode = false;

    const cardsContainer = document.getElementById('cardsContainer');
    const interpretation = document.getElementById('interpretation');
    const drawBtn = document.getElementById('drawBtn');
    const includeMinorToggle = document.getElementById('includeMinor');
    const showReversalsToggle = document.getElementById('showReversals');
    const enableSoundToggle = document.getElementById('enableSound');
    const foolCanvas = document.getElementById('foolCanvas');
    const ctx = foolCanvas.getContext && foolCanvas.getContext('2d');

    // Responsive canvas
    function resizeCanvas(){
      foolCanvas.width = innerWidth * devicePixelRatio;
      foolCanvas.height = innerHeight * devicePixelRatio;
      foolCanvas.style.width = innerWidth + 'px';
      foolCanvas.style.height = innerHeight + 'px';
      ctx && ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Spread selector interactions
    document.querySelectorAll('.spread-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.spread-card').forEach(c => {
          c.classList.remove('active');
          c.setAttribute('aria-selected','false');
        });
        card.classList.add('active');
        card.setAttribute('aria-selected','true');
        currentSpread = card.dataset.spread;
        cardsContainer.innerHTML = '';
        interpretation.classList.remove('show');
      });
    });

    // Build pool (major + optional minor)
    function buildPool(){
      let pool = [...majorArcana];
      if(includeMinorToggle.checked) pool = pool.concat(minorArcana);
      return pool;
    }

    // Draw card from pool; can force Fool or allow reversals
    function drawCardFromPool(pool, forceFool=false, allowReversal=true){
      if(forceFool) return {...majorArcana[0], reversed:false};
      const idx = Math.floor(Math.random() * pool.length);
      const card = pool[idx];
      const reversed = allowReversal && Math.random() < 0.35;
      return {...card, reversed};
    }

    // Small dynamic SVG "artwork" placeholder generator (returns svg string)
    function svgArtFor(name, accentHue=260){
      // Simple decorative sigil with initials and gradient ‚Äî deterministic-ish from name
      const seed = [...name].reduce((s,c)=>s + c.charCodeAt(0), 0);
      const hue = (accentHue + (seed % 60)) % 360;
      const bg = `linearGradient-${seed}`;
      const svg =
        `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 200' preserveAspectRatio='xMidYMid slice'>
          <defs>
            <linearGradient id='g${seed}' x1='0' x2='1'>
              <stop offset='0' stop-color='hsl(${hue},80%,60%)'/>
              <stop offset='1' stop-color='hsl(${(hue+40)%360},70%,45%)'/>
            </linearGradient>
            <filter id='grain${seed}'><feTurbulence baseFrequency='0.9' numOctaves='1' stitchTiles='stitch'/></filter>
          </defs>
          <rect width='100%' height='100%' rx='12' fill='url(#g${seed})' opacity='0.95'/>
          <g transform='translate(200,100)'>
            <circle r='62' fill='rgba(255,255,255,0.06)'/>
            <path d='M-48 16 C-28 36, 28 36, 48 16' stroke='rgba(255,255,255,0.16)' stroke-width='6' fill='none' stroke-linecap='round'/>
            <text x='0' y='12' font-family='Cinzel, serif' font-size='44' fill='rgba(255,255,255,0.9)' text-anchor='middle'>${name.split(' ').map(n=>n[0]||'').slice(0,2).join('')}</text>
          </g>
        </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    // Tilt effect for each card
    function enableTilt(cardEl){
      const inner = cardEl.querySelector('.card-inner');
      cardEl.addEventListener('mousemove', (e) => {
        const r = cardEl.getBoundingClientRect();
        const px = (e.clientX - r.left) / r.width;
        const py = (e.clientY - r.top) / r.height;
        const rx = (py - 0.5) * -10;
        const ry = (px - 0.5) * 10;
        inner.style.transform = `rotateY(${ry}deg) rotateX(${rx}deg) ${cardEl.classList.contains('flipped') ? 'rotateY(180deg)' : ''}`;
      });
      cardEl.addEventListener('mouseleave', () => {
        inner.style.transform = cardEl.classList.contains('flipped') ? 'rotateY(180deg)' : 'none';
      });
    }

    // WebAudio chime (soft or fool)
    function playChime(type='soft'){
      if(!enableSoundToggle.checked || !window.AudioContext) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const now = ctx.currentTime;
        if(type === 'fool'){
          // cluster-ish chord
          const freqs = [220, 266.5, 311.1];
          const gains = freqs.map(() => ctx.createGain());
          freqs.forEach((f,i) => {
            const o = ctx.createOscillator();
            o.type = 'sine';
            o.frequency.setValueAtTime(f, now);
            o.connect(gains[i]);
            gains[i].connect(ctx.destination);
            gains[i].gain.setValueAtTime(0.0001, now);
            gains[i].gain.exponentialRampToValueAtTime(0.12/(i+1), now+0.02);
            gains[i].gain.exponentialRampToValueAtTime(0.0001, now+1.2);
            o.start(now);
            o.stop(now+1.25);
          });
        } else {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          o.frequency.setValueAtTime(660, now);
          o.connect(g); g.connect(ctx.destination);
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.12, now+0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now+1.0);
          o.start(now); o.stop(now+1.1);
        }
      } catch(e) { /* silently fail on unsupported devices */ }
    }

    // Subtle canvas particle bloom for fool mode
    const particles = [];
    function spawnParticles(){
      particles.length = 0;
      for(let i=0;i<80;i++){
        particles.push({
          x: Math.random()*innerWidth,
          y: Math.random()*innerHeight,
          vx: (Math.random()-0.5)*0.7,
          vy: (Math.random()-0.5)*0.7 - 0.2,
          size: 1 + Math.random()*3,
          hue: 260 + Math.random()*120,
          life: 60 + Math.random()*160
        });
      }
    }
    let particleAnimId = null;
    function animateParticles(){
      if(!ctx) return;
      ctx.clearRect(0,0,foolCanvas.width, foolCanvas.height);
      const dpr = devicePixelRatio || 1;
      ctx.save();
      ctx.scale(dpr,dpr);
      particles.forEach((p) => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.002;
        p.life--;
        const alpha = Math.max(0, Math.min(1, p.life/180));
        ctx.beginPath();
        ctx.fillStyle = `hsla(${p.hue},85%,62%,${alpha*0.85})`;
        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fill();
        if(p.life <= 0){
          p.x = Math.random()*innerWidth;
          p.y = innerHeight + 10;
          p.vx = (Math.random()-0.5)*0.7;
          p.vy = -(0.6+Math.random()*1.2);
          p.life = 60 + Math.random()*180;
        }
      });
      ctx.restore();
      particleAnimId = requestAnimationFrame(animateParticles);
    }
    function startFoolCanvas(){ spawnParticles(); if(particleAnimId==null) animateParticles(); foolCanvas.style.display = 'block'; }
    function stopFoolCanvas(){ foolCanvas.style.display = 'none'; if(particleAnimId!=null){ cancelAnimationFrame(particleAnimId); particleAnimId = null; } ctx && ctx.clearRect(0,0,foolCanvas.width,foolCanvas.height); }

    // Show card detail in interpretation panel
    function showCardDetail(card){
      const revNote = card.reversed ? `<p style="margin-top:8px;color:var(--muted)"><strong>Reversed:</strong> ${card.reversed}</p>` : '';
      interpretation.innerHTML = `
        <h2>üîé ${card.name}</h2>
        <div class="card-detail">
          <h3>${card.emoji} ${card.position || ''}</h3>
          <p>${card.detail}</p>
          ${revNote}
        </div>
      `;
      interpretation.classList.add('show');
      interpretation.scrollIntoView({behavior:'smooth', block:'center'});
    }

    // Main draw handler (with rarer Fool's Blessing)
    drawBtn.addEventListener('click', () => {
      readingCount++;
      // Lowered odds: small flat chance (~6%) per reading to trigger Fool mode
      const foolProbability = 0.06;
      const shouldActivateFool = Math.random() < foolProbability;
      foolMode = shouldActivateFool;

      const pool = buildPool();
      cardsContainer.innerHTML = '';
      interpretation.innerHTML = '';
      interpretation.classList.remove('show');

      let numCards, positions;
      if(currentSpread === 'single'){ numCards = 1; positions = ['Your Answer']; }
      else if(currentSpread === 'three'){ numCards = 3; positions = ['Past', 'Present', 'Future']; }
      else { numCards = 5; positions = ['Present', 'Challenge', 'Past', 'Future', 'Outcome']; }

      // audio + canvas
      playChime(foolMode ? 'fool' : 'soft');
      if(foolMode) startFoolCanvas(); else stopFoolCanvas();

      // Draw cards from pool
      const drawn = [];
      for(let i=0;i<numCards;i++){
        const card = drawCardFromPool(pool, foolMode, showReversalsToggle.checked);
        drawn.push({...card, position: positions[i] || `Pos ${i+1}`});
      }

      // Render card elements (staggered reveal)
      drawn.forEach((card, idx) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'tarot-card';
        cardEl.setAttribute('tabindex','0');

        const reversedBadge = card.reversed ? `<div class="reversed-indicator">‚Ü∑ Reversed</div>` : '';
        const frontClass = foolMode ? 'fool-mode' : '';

        // Use svg art data URI in an <img> for better rendering; fallback emoji remains
        const svgUri = svgArtFor(card.name, 260 + (card.name.length % 90));

        cardEl.innerHTML = `
          <div class="card-inner">
            <div class="card-face card-back" aria-hidden="true">
              <div class="sigil" aria-hidden="true">
                <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" role="img">
                  <defs>
                    <linearGradient id="sg1" x1="0" x2="1">
                      <stop offset="0" stop-color="rgba(255,255,255,0.09)"/>
                      <stop offset="1" stop-color="rgba(255,255,255,0.02)"/>
                    </linearGradient>
                  </defs>
                  <rect width="120" height="120" rx="10" fill="url(#sg1)"/>
                  <g transform="translate(60,60)">
                    <circle r="30" fill="rgba(255,255,255,0.03)"/>
                    <path d="M-22 10 C-5 28, 5 28, 22 10" stroke="rgba(255,255,255,0.07)" stroke-width="2" fill="none" stroke-linecap="round"/>
                    <text x="0" y="6" font-family="Cinzel, serif" font-size="22" fill="rgba(255,255,255,0.12)" text-anchor="middle">${card.name.split(' ').map(x=>x[0]||'').slice(0,2).join('')}</text>
                  </g>
                </svg>
              </div>
            </div>
            <div class="card-face card-front ${frontClass}">
              ${reversedBadge}
              <div class="card-art"><img src="${svgUri}" alt="${card.name} art" /></div>
              <div class="card-emoji">${card.emoji || ''}</div>
              <div class="card-name">${card.name}</div>
              <div class="card-meaning">${card.meaning}</div>
            </div>
          </div>
        `;

        // timing of insertion & flip
        setTimeout(() => {
          cardsContainer.appendChild(cardEl);
          enableTilt(cardEl);
          setTimeout(() => cardEl.classList.add('flipped'), 90);
          // attach card data and interaction handlers
          cardEl._card = card;
          cardEl.addEventListener('click', () => showCardDetail(cardEl._card));
          cardEl.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' || e.key === ' ') {
              e.preventDefault(); showCardDetail(cardEl._card);
            }
          });
        }, idx * 240);
      });

      // Interpretation panel after reveal
      setTimeout(() => {
        if(foolMode){
          // Stronger LOTM-flavored homage text (no quotes, thematic)
          interpretation.innerHTML = `
            <div class="praise">üÉè THE FOOL'S BLESSING</div>
            <p style="text-align:center; font-size:16px; color:var(--muted); font-style:italic;">
              The Fool tugs a corner of the veil. Expect ciphers, orders, and motifs repeating like ritual marks ‚Äî an atmosphere reminiscent of secret histories and odd societies such as those in "Lord of the Mysteries".
            </p>
            <div class="card-detail">
              <h3>üîÆ The Fool as Cipher</h3>
              <p>The Fool does not merely interrupt: it reframes. Under this blessing, patterns that once looked accidental may now read as intentional signatures. Consider masks, repeated numbers, seemingly harmless coincidences that anchor deeper plots. The Fool invites you to regard life as if you were reading a manual written in metaphor ‚Äî symbolic acts, hidden directories, and the sense that a quiet society catalogs your steps.</p>
            </div>
            <div class="card-detail">
              <h3>üïØÔ∏è How to Use this Reading</h3>
              <p>Treat this reading like a dossier. Note recurring symbols and phrases. When the Fool appears, keep a small notebook of motifs and look for correspondences: people who act as 'agents', places where rituals repeat, and the recurring image that keeps showing up in your decisions. The blessing is not an answer ‚Äî it's an invitation to decode.</p>
            </div>
          `;
        } else {
          let html = '<h2>‚ú® Your Reading</h2>';
          drawn.forEach(card => {
            html += `
              <div class="card-detail">
                <h3>${card.emoji} ${card.position || ''}: ${card.name}</h3>
                <p>${card.detail}</p>
                ${card.reversed ? `<p style="margin-top:8px;color:var(--muted)"><strong>Reversed:</strong> ${card.reversed}</p>` : ''}
              </div>
            `;
          });
          interpretation.innerHTML = html;
        }
        interpretation.classList.add('show');
        interpretation.setAttribute('tabindex','-1');
        interpretation.focus({preventScroll:true});
      }, numCards * 280 + 420);
    });

    // initial UI hint
    setTimeout(() => {
      const hint = document.createElement('div');
      hint.className = 'control';
      hint.style.margin = '10px auto';
      hint.style.textAlign = 'center';
      hint.textContent = 'Tip: Toggle Minor Arcana to expand the deck. Click any card for an expanded interpretation.';
      document.querySelector('.container').insertBefore(hint, document.querySelector('.container').children[4]);
      setTimeout(()=>hint.remove(), 10000);
    }, 700);

    // hide canvas at start
    stopFoolCanvas();
  </script>
</body>
</html>

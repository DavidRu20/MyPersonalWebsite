<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arcane Divination ¬∑ Tarot Reading (No overlap)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0612;
      --panel:#120a1f;
      --text:#e8e4f0;
      --muted:#9b8fb8;
      --brand:#d946ef;
      --brand-2:#f59e0b;
      --glass-brd: rgba(139,92,246,.25);
      --shadow: 0 10px 40px rgba(217,70,239,.25);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(ellipse 1400px 900px at 90% -15%, rgba(217,70,239,.18), transparent 55%),
        radial-gradient(ellipse 1000px 700px at 10% 100%, rgba(245,158,11,.12), transparent 50%),
        var(--bg);
      color:var(--text);
      padding:20px;
      -webkit-font-smoothing:antialiased;
    }

    .container{max-width:960px;margin:0 auto}

    .header{text-align:center;padding:32px 12px 6px}
    .header h1{font-family:Cinzel,serif;font-size:clamp(28px,5vw,42px);font-weight:900;
      background:linear-gradient(120deg,var(--brand),var(--brand-2)); -webkit-background-clip:text; color:transparent;}
    .header p{color:var(--muted);margin-top:6px}

    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:14px 0}
    .control{background:rgba(255,255,255,0.02);border:1px solid var(--glass-brd);padding:8px 12px;border-radius:12px;color:var(--text);font-size:14px}

    .btn{display:inline-block;margin:12px auto;padding:12px 26px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border:none;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}

    /* IMPORTANT: keep both containers in normal document flow (no forced stacking), and reserve space for cards */
    .cards-container{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      min-height:320px; /* reserve vertical space so interpretation will not overlap */
      margin:26px 0;
      position:relative; /* not absolute/fixed */
      /* no z-index manipulations here -> follow normal stacking */
    }

    .tarot-card{
      width:170px;height:270px;perspective:1000px;cursor:pointer;position:relative;
      transition:transform .2s ease,opacity .25s ease;
      opacity:0; /* become visible when flipped */
      will-change:transform,opacity;
    }

    .card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .75s ease;border-radius:14px}
    .tarot-card.flipped .card-inner{transform:rotateY(180deg)}
    .card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px;border:2px solid var(--glass-brd);box-shadow:var(--shadow);overflow:hidden}

    .card-back{background:linear-gradient(135deg, rgba(139,92,246,.22), rgba(245,158,11,.12));display:flex;align-items:center;justify-content:center;font-size:64px}
    .card-front{background:linear-gradient(135deg,var(--panel),rgba(18,10,31,.95));transform:rotateY(180deg);text-align:center}

    .card-art{width:100%;height:110px;border-radius:10px;overflow:hidden;margin-bottom:8px}
    .card-art img{width:100%;height:100%;object-fit:cover}
    .card-name{font-family:Cinzel,serif;font-size:15px;color:var(--brand-2);margin-bottom:6px}
    .card-meaning{font-size:13px;color:var(--muted)}

    .reversed-indicator{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.35);padding:6px 8px;border-radius:999px;color:var(--brand-2);font-weight:700}

    /* Interpretation sits below cards and will never overlap because cards-container reserves space */
    .interpretation{
      background:linear-gradient(135deg, rgba(139,92,246,.08), rgba(245,158,11,.06));
      border:1px solid var(--glass-brd);
      border-radius:14px;
      padding:20px;
      margin-top:8px;
      transition:opacity .35s ease,transform .35s ease;
      opacity:0; transform:translateY(8px);
      position:relative; /* normal flow */
    }
    .interpretation.show{opacity:1;transform:none}

    .card-detail{margin:12px 0;padding:12px;border-radius:10px;background:rgba(0,0,0,.12);border-left:4px solid var(--brand)}
    .card-detail h3{font-family:Cinzel,serif;color:var(--brand);margin-bottom:8px}

    /* keep canvas (fool particles) behind content */
    #foolCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:0;mix-blend-mode:screen}

    @media (max-width:640px){
      .tarot-card{width:150px;height:240px}
      .cards-container{min-height:300px}
    }
  </style>
</head>
<body>
  <canvas id="foolCanvas" aria-hidden="true"></canvas>

  <div class="container">
    <header class="header">
      <h1>üîÆ Arcane Divination</h1>
      <p>Cards and text will no longer overlap ‚Äî the layout reserves space for the cards.</p>
    </header>

    <div class="controls" aria-hidden="false">
      <label class="control"><input id="includeMinor" type="checkbox"> Include Minor Arcana</label>
      <label class="control"><input id="showReversals" type="checkbox" checked> Allow Reversals</label>
      <label class="control"><input id="enableSound" type="checkbox"> Ambient Sound</label>
    </div>

    <div style="text-align:center"><button id="drawBtn" class="btn">‚ú® Divine Your Fate ‚ú®</button></div>

    <!-- cards container: always occupies space, preventing overlap -->
    <div id="cardsContainer" class="cards-container" aria-live="polite" aria-atomic="true"></div>

    <!-- interpretation is below cardsContainer, and CSS reserves vertical space so they don't overlap -->
    <div id="interpretation" class="interpretation" aria-live="polite"></div>
  </div>

  <script>
    // simplified deck (keeps structure; use your full deck instead)
    const majorArcana = [
      {name:'The Fool',emoji:'üÉè',meaning:'New beginnings, spontaneity',detail:'A threshold of possibility. Small step > perfect plan.',reversed:'Recklessness or hesitation.'},
      {name:'The Magician',emoji:'üé©',meaning:'Manifestation, resourcefulness',detail:'Agency and focused action ‚Äî choose one measurable step.',reversed:'Scattered energy.'},
      {name:'The High Priestess',emoji:'üåô',meaning:'Intuition, inner knowledge',detail:'Listen to dreams and quiet prompts; journal symbols.',reversed:'Blocked inner voice.'},
      {name:'The Empress',emoji:'üëë',meaning:'Nurturing, abundance',detail:'Tend a creative project like a garden; nurture systems.',reversed:'Creative block.'},
      {name:'The World',emoji:'üåç',meaning:'Completion, fulfillment',detail:'Celebrate completion, close cycles before new ones.',reversed:'Unfinished business.'}
    ];

    const suits = [
      {name:'Wands',emoji:'üî•',tone:'will, inspiration'},
      {name:'Cups',emoji:'üíß',tone:'emotion, relationships'},
      {name:'Swords',emoji:'üí®',tone:'mind, conflict'},
      {name:'Pentacles',emoji:'üåø',tone:'material, craft'}
    ];
    const ranks = ['Ace','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Page','Knight','Queen','King'];

    function buildMinor(){
      const arr=[];
      for(const s of suits){
        for(const r of ranks){
          const name = `${r} of ${s.name}`;
          const meaning = `${r} energy in ${s.tone}`;
          const detail = `${meaning}. Ask: what concrete step, conversation, or craft will express this today?`;
          const reversed = `Shadow of the ${r.toLowerCase()}: blocked or misapplied ${s.tone}.`;
          arr.push({name,emoji:s.emoji,meaning,detail,suit:s.name,rank:r,reversed});
        }
      }
      return arr;
    }
    const minorArcana = buildMinor();

    // state & refs
    const cardsContainer = document.getElementById('cardsContainer');
    const interpretation = document.getElementById('interpretation');
    const includeMinor = document.getElementById('includeMinor');
    const showReversals = document.getElementById('showReversals');
    const enableSound = document.getElementById('enableSound');
    const drawBtn = document.getElementById('drawBtn');
    const foolCanvas = document.getElementById('foolCanvas');
    const ctx = foolCanvas.getContext ? foolCanvas.getContext('2d') : null;

    let currentSpread = 'single';
    document.querySelectorAll('.header, .controls').forEach(n => n.style.pointerEvents = 'auto');

    // helper pool builder
    function pool(){
      let p = [...majorArcana];
      if(includeMinor.checked) p = p.concat(minorArcana);
      return p;
    }

    function drawOne(p, forceFool=false){
      if(forceFool) return {...majorArcana[0],reversed:false};
      const idx = Math.floor(Math.random()*p.length);
      const card = p[idx];
      const reversed = showReversals.checked && Math.random() < 0.35;
      return {...card, reversed};
    }

    // svg placeholder
    function svgArtFor(name){
      const seed = [...name].reduce((s,c)=>s+c.charCodeAt(0),0);
      const hue = 220 + (seed % 100);
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 200'><defs><linearGradient id='g${seed}' x1='0' x2='1'><stop offset='0' stop-color='hsl(${hue},70%,60%)'/><stop offset='1' stop-color='hsl(${(hue+40)%360},60%,45%)'/></linearGradient></defs><rect width='100%' height='100%' rx='12' fill='url(#g${seed})'/><text x='200' y='110' font-family='Cinzel, serif' font-size='44' text-anchor='middle' fill='rgba(255,255,255,0.9)'>${name.split(' ').map(x=>x[0]||'').slice(0,2).join('')}</text></svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    // tilt effect
    function enableTilt(cardEl){
      const inner = cardEl.querySelector('.card-inner');
      cardEl.addEventListener('mousemove', e => {
        const r = cardEl.getBoundingClientRect();
        const px = (e.clientX - r.left)/r.width;
        const py = (e.clientY - r.top)/r.height;
        const rx = (py - 0.5) * -8;
        const ry = (px - 0.5) * 8;
        inner.style.transform = `rotateY(${ry}deg) rotateX(${rx}deg) ${cardEl.classList.contains('flipped') ? 'rotateY(180deg)' : ''}`;
      });
      cardEl.addEventListener('mouseleave', () => {
        inner.style.transform = cardEl.classList.contains('flipped') ? 'rotateY(180deg)' : 'none';
      });
    }

    // audio minimal
    function playChime(type='soft'){
      if(!enableSound.checked || !window.AudioContext) return;
      try{
        const a = new (window.AudioContext||window.webkitAudioContext)();
        const now = a.currentTime;
        if(type==='fool'){
          [220,266.5,311.1].forEach((f,i)=>{ const o=a.createOscillator(); const g=a.createGain(); o.type='sine'; o.frequency.setValueAtTime(f,now); o.connect(g); g.connect(a.destination); g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.12/(i+1), now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+1.2); o.start(now); o.stop(now+1.25);});
        } else {
          const o=a.createOscillator(); const g=a.createGain(); o.type='sine'; o.frequency.setValueAtTime(660,now); o.connect(g); g.connect(a.destination); g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.12, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+1.0); o.start(now); o.stop(now+1.1);
        }
      }catch(e){}
    }

    // ensure canvas sizing
    function resizeCanvas(){
      if(!ctx) return;
      foolCanvas.width = innerWidth * devicePixelRatio;
      foolCanvas.height = innerHeight * devicePixelRatio;
      foolCanvas.style.width = innerWidth + 'px';
      foolCanvas.style.height = innerHeight + 'px';
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // flip-only reveal and guarantee no overlap:
    // - cardsContainer reserves vertical space via CSS min-height
    // - we append all cards immediately, set them to invisible, flip them (opacity + transform)
    // - interpretation is inserted AFTER flipping completes and is guaranteed to render below cardsContainer
    drawBtn.addEventListener('click', () => {
      const foolProbability = 0.10;
      const foolMode = Math.random() < foolProbability;

      const deck = pool();
      cardsContainer.innerHTML = '';
      interpretation.classList.remove('show');
      interpretation.innerHTML = '';

      const spread = currentSpread || 'single';
      let numCards = 1, positions = ['Your Answer'];
      if(spread === 'three'){ numCards = 3; positions = ['Past','Present','Future']; }
      if(spread === 'celtic'){ numCards = 5; positions = ['Present','Challenge','Past','Future','Outcome']; }

      playChime(foolMode ? 'fool' : 'soft');

      // draw
      const drawn = [];
      for(let i=0;i<numCards;i++){
        drawn.push(drawOne(deck, foolMode));
      }

      // create elements and append immediately (no layout-shifting drop)
      drawn.forEach((card, idx) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'tarot-card';
        cardEl.setAttribute('tabindex','0');
        cardEl.style.opacity = '0'; // visible when flipped
        const reversedBadge = card.reversed ? '<div class="reversed-indicator">‚Ü∑ Reversed</div>' : '';
        const svg = svgArtFor(card.name || ('Card'+idx));
        cardEl.innerHTML = `
          <div class="card-inner" aria-hidden="false">
            <div class="card-face card-back" aria-hidden="true"><div style="font-size:28px;opacity:.6">üîÆ</div></div>
            <div class="card-face card-front">
              ${reversedBadge}
              <div class="card-art"><img src="${svg}" alt="${card.name} art" /></div>
              <div class="card-name">${card.name}</div>
              <div class="card-meaning">${card.meaning || ''}</div>
            </div>
          </div>
        `;
        cardEl._card = card;
        cardEl.addEventListener('click', () => showCardDetail(cardEl._card));
        cardEl.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showCardDetail(cardEl._card); }});
        cardsContainer.appendChild(cardEl);
        enableTilt(cardEl);
      });

      // force reflow and flip all simultaneously (no staggering)
      requestAnimationFrame(() => {
        document.querySelectorAll('.tarot-card').forEach(el => {
          // small polish delay so flip feels deliberate instead of instant
          setTimeout(() => {
            el.classList.add('flipped');
            el.style.opacity = '1';
          }, 80);
        });
      });

      // Wait for flip transition to end before showing the interpretation panel below.
      // Using a timeout that matches the CSS transition duration ensures the interpretation appears after cards finish flipping,
      // and because cards-container reserved space, the interpretation will not overlap.
      const flipDurationMs = 800;
      setTimeout(() => {
        if(foolMode){
          interpretation.innerHTML = `
            <div style="font-weight:900;font-family:Cinzel,serif;font-size:20px;color:var(--brand-2);margin-bottom:8px">üÉè THE FOOL'S BLESSING</div>
            <div class="card-detail"><h3>üîÆ The Fool as Cipher</h3><p>The Fool reframes events as possible signs and signals. Keep a motif log and watch for symbols repeating across days. This reading nudges you to treat curiosities as potential clues.</p></div>
            <div class="card-detail"><h3>üïØÔ∏è Use the Blessing</h3><p>Record repeated names, numbers, and places. Revisit them in a week and look for patterns ‚Äî the Fool rewards patient curiosity.</p></div>
          `;
        } else {
          let html = '<h2 style="font-family:Cinzel,serif;color:var(--brand-2);margin-bottom:8px">‚ú® Your Reading</h2>';
          // Use the drawn order and show details; ensure the interpretation is below the cards
          document.querySelectorAll('#cardsContainer .tarot-card').forEach((el, i) => {
            const card = drawn[i];
            card.position = (i < positions.length) ? positions[i] : `Position ${i+1}`;
            html += `<div class="card-detail"><h3>${card.emoji || ''} ${card.position}: ${card.name}</h3><p>${card.detail || card.meaning || ''}</p>${card.reversed ? `<p style="color:var(--muted);margin-top:6px"><strong>Reversed:</strong> ${card.reversed}</p>` : ''}</div>`;
          });
          interpretation.innerHTML = html;
        }
        // ensure interpretation shows (and because cards container reserves space, there will be no overlap)
        interpretation.classList.add('show');
        // scroll so the interpretation is visible immediately after flip completes
        interpretation.scrollIntoView({behavior:'smooth', block:'start'});
      }, flipDurationMs + 100);
    });

    // show card detail in interpretation (keeps interpretation below)
    function showCardDetail(card){
      const rev = card.reversed ? `<p style="color:var(--muted);margin-top:8px"><strong>Reversed:</strong> ${card.reversed}</p>` : '';
      interpretation.innerHTML = `<h2 style="font-family:Cinzel,serif;color:var(--brand-2)">${card.name}</h2><div class="card-detail"><h3>${card.emoji || ''} ${card.position || ''}</h3><p>${card.detail || card.meaning || ''}</p>${rev}</div>`;
      interpretation.classList.add('show');
      interpretation.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // initial hint
    setTimeout(()=> {
      const hint = document.createElement('div');
      hint.className = 'control';
      hint.style.textAlign = 'center';
      hint.style.margin = '10px auto';
      hint.textContent = 'Cards now flip (no drop) and the layout reserves vertical space to prevent any overlap between cards and text.';
      document.querySelector('.container').insertBefore(hint, document.getElementById('cardsContainer'));
      setTimeout(()=>hint.remove(),9000);
    }, 600);
  </script>
</body>
</html>
